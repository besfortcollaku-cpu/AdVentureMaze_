// src/ui/ui.js

export function mountUI(app) {
  app.innerHTML = `
    <div class="phone">
      <div class="topbar">
        <div class="topRow">
          <div class="brand">
            <div class="logoBox" title="Adventure Maze">
              <img src="/logo.png" alt="Adventure Maze Logo" />
            </div>
          </div>

          <div class="levelWrap">
            <div class="levelNew">NEW!</div>
            <div class="levelText">Adventure Maze</div>
          </div>

          <div class="coins" title="Coins">
            <div class="coinDot"></div>
            <div id="coinCount">0</div>
          </div>
        </div>

        <div class="iconRow">
          ${iconBtn("settingsBtn", gearSVG(), "")}
          ${iconBtn("controls", joystickSVG(), "")}
          ${iconBtn("paint", brushSVG(), "NEW")}
          ${iconBtn("trophy", trophySVG(), "")}
          ${iconBtn("noads", noAdsSVG(), "")}

          <div class="loginWrap">
            <button class="iconBtnWide" id="loginBtn">
              <span id="loginBtnText">Login with Pi</span>
            </button>
            <div class="userPill" id="userPill">User: guest</div>
          </div>
        </div>
      </div>

      <div class="boardWrap">
        <div class="boardFrame">
          <canvas id="game"></canvas>
        </div>
      </div>

      <div class="bottomBar">
        <button class="btn" id="hintBtn">
          <div class="btnIcon">üé¨</div>
          <div>HINT</div>
        </button>

        <div class="pill">Swipe to move</div>

        <button class="btn" id="x3Btn">
          <div class="btnIcon">‚è©</div>
          <div>√ó3</div>
        </button>
      </div>
    </div>

    <!-- Desktop block (used by Pi detection) -->
    <div class="desktopBlock" id="desktopBlock" style="display:none;">
      <div class="desktopCard">
        <h2>Mobile game</h2>
        <p>This game is designed for smartphones. Use swipe on mobile. Desktop is only for testing (arrow keys).</p>
      </div>
    </div>

    <!-- ‚úÖ SETTINGS OVERLAY -->
    <div class="settingsOverlay" id="settingsOverlay" aria-hidden="true">
      <div class="settingsCard">
        <div class="settingsHeader">
          <div class="settingsTitle">Settings</div>
          <button class="settingsClose" id="settingsCloseBtn" aria-label="Close">‚úï</button>
        </div>

        <div class="settingsRow">
          <div class="settingsLeft">
            <div class="settingsLabel">Sound</div>
            <div class="settingsSub">Rolling + victory (no wall-hit sound)</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="soundToggle" />
            <span class="track"></span>
          </label>
        </div>

        <div class="settingsRow">
          <div class="settingsLeft">
            <div class="settingsLabel">Vibration</div>
            <div class="settingsSub">Small vibration when ball stops</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="vibrationToggle" />
            <span class="track"></span>
          </label>
        </div>

        <div class="settingsFoot">
          <div class="settingsNote">Changes are saved automatically.</div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ WIN POPUP -->
    <div class="winOverlay" id="winOverlay" aria-hidden="true">
      <div class="winCard">
        <div class="winSparkLayer"></div>

        <div class="winHeader">
          <div class="winBadge">CONGRATS!</div>
          <div class="winTitle">Level Complete</div>
          <div class="winSub" id="winSubText">You finished Level</div>
        </div>

        <div class="winMusic">
          <div class="winPulse"></div>
          <div class="winNote">‚ô™</div>
          <div class="winMusicText">Victory vibes</div>
        </div>

        <div class="winRow">
          <button class="winBtnPrimary" id="winNextBtn">Next level</button>
          <button class="winBtnSecondary" id="winAdBtn">
            Watch Ad <span class="winPlus">+50</span>
            <span class="winCoinDot" aria-hidden="true"></span>
          </button>
        </div>

        <div class="winHint">Tip: Watch ad gives +50 coins</div>
      </div>
    </div>

    <!-- ‚úÖ LOGIN GATE (mandatory Pi login) -->
    <div class="gateOverlay" id="loginGate" aria-hidden="true">
      <div class="gateCard">
        <div class="gateTitle">Login required</div>
        <div class="gateSub">Please login with Pi Network to play.</div>

        <button class="gateBtn" id="gateLoginBtn">Retry login</button>

        <div class="gateError" id="gateError" role="alert" style="display:none;"></div>
        <div class="gateTip">Tip: If Pi asks permission, accept it to continue.</div>
      </div>
    </div>
  `;

  // ‚úÖ Inject missing UI styles (Settings + Win + Login Gate + login wrap)
  const extra = document.createElement("style");
  extra.textContent = `
    .loginWrap{ display:flex; gap:10px; align-items:center; margin-left:auto; }
    .iconBtnWide{
      height:42px; padding:0 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(18,28,60,.55);
      color:#fff; font-weight:800; letter-spacing:.2px;
      cursor:pointer; white-space:nowrap;
    }
    .iconBtnWide:active{ transform: translateY(1px); }
    .iconBtnWide:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .userPill{
      height:42px; display:flex; align-items:center;
      padding:0 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(234,243,255,.9);
      font-weight:700; font-size:13px; white-space:nowrap;
    }
    @media (max-width: 420px){
      .loginWrap{ width:100%; justify-content:space-between; margin-left:0; }
      .iconBtnWide{ flex:1; }
      .userPill{ flex:1; justify-content:center; }
    }

    /* SETTINGS */
    .settingsOverlay{
      position:fixed; inset:0; z-index:99999;
      display:none; align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
    }
    .settingsOverlay.show{ display:flex; }
    .settingsCard{
      width:min(520px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,30,.88);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:16px;
      color: rgba(240,247,255,.95);
    }
    .settingsHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .settingsTitle{ font-size:18px; font-weight:900; letter-spacing:.3px; }
    .settingsClose{
      width:40px; height:40px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff; font-weight:900;
      cursor:pointer;
    }
    .settingsClose:active{ transform: translateY(1px); }
    .settingsRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 10px;
      border-radius:16px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      margin-top:10px;
    }
    .settingsLeft{ display:flex; flex-direction:column; gap:3px; }
    .settingsLabel{ font-weight:900; font-size:14px; }
    .settingsSub{ opacity:.78; font-size:12px; line-height:1.25; }

    .toggle{ position:relative; width:52px; height:30px; display:inline-block; }
    .toggle input{ opacity:0; width:0; height:0; }
    .toggle .track{
      position:absolute; inset:0;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      transition: .15s ease;
    }
    .toggle .track::after{
      content:"";
      position:absolute;
      width:24px; height:24px;
      left:3px; top:2px;
      border-radius:50%;
      background: rgba(240,247,255,.95);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
      transition: .15s ease;
    }
    .toggle input:checked + .track{
      background: rgba(37,215,255,.25);
      border-color: rgba(37,215,255,.45);
    }
    .toggle input:checked + .track::after{
      transform: translateX(22px);
      background: #25d7ff;
    }

    .settingsFoot{ margin-top:12px; padding:8px 4px 0; }
    .settingsNote{ opacity:.7; font-size:12px; }

    /* WIN POPUP */
    .winOverlay{
      position:fixed; inset:0; z-index:99998;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .winOverlay.show{ display:flex; }
    .winCard{
      width:min(560px, 100%);
      border-radius:24px;
      border:1px solid rgba(37,215,255,.22);
      background: radial-gradient(900px 520px at 50% 10%, rgba(37,215,255,.18), rgba(10,12,24,.92));
      box-shadow: 0 22px 80px rgba(0,0,0,.65);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .winSparkLayer{
      position:absolute; inset:-40px;
      background:
        radial-gradient(10px 10px at 10% 20%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(12px 12px at 80% 30%, rgba(37,215,255,.7), transparent 60%),
        radial-gradient(9px 9px at 35% 70%, rgba(255,204,51,.7), transparent 60%),
        radial-gradient(8px 8px at 65% 80%, rgba(255,255,255,.55), transparent 60%);
      opacity:.35;
      animation: sparks 1.6s linear infinite;
      pointer-events:none;
    }
    @keyframes sparks{
      0%{ transform: translateY(0); }
      100%{ transform: translateY(18px); }
    }
    .winHeader{ position:relative; z-index:2; display:flex; flex-direction:column; gap:6px; }
    .winBadge{
      align-self:flex-start;
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, #ff4b3a, #d61e12);
      box-shadow: 0 12px 22px rgba(255,75,58,.25);
      border:1px solid rgba(255,255,255,.18);
    }
    .winTitle{ font-size:26px; font-weight:950; letter-spacing:.3px; }
    .winSub{ opacity:.82; font-size:13px; }

    .winMusic{
      position:relative; z-index:2;
      margin-top:14px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .winPulse{
      width:34px; height:34px; border-radius:50%;
      background: rgba(37,215,255,.22);
      border:1px solid rgba(37,215,255,.35);
      animation: pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:.75; }
      50%{ transform: scale(1.08); opacity:1; }
    }
    .winNote{ font-weight:950; font-size:18px; }
    .winMusicText{ font-weight:900; opacity:.85; }

    .winRow{ position:relative; z-index:2; display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    .winBtnPrimary, .winBtnSecondary{
      height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      font-weight:950;
      cursor:pointer;
      padding:0 14px;
    }
    .winBtnPrimary{
      flex:1;
      background: linear-gradient(180deg, rgba(37,215,255,.95), rgba(0,183,255,.85));
      color:#061020;
      border-color: rgba(37,215,255,.55);
    }
    .winBtnSecondary{
      flex:1;
      background: rgba(255,255,255,.06);
      color: rgba(240,247,255,.95);
    }
    .winBtnPrimary:active, .winBtnSecondary:active{ transform: translateY(1px); }
    .winPlus{ margin-left:6px; font-weight:950; color:#ffcc33; }
    .winCoinDot{
      display:inline-block;
      width:14px; height:14px;
      border-radius:50%;
      margin-left:8px;
      background: radial-gradient(circle at 30% 30%, #fff6c2, #ffcc33 55%, #d39a00);
      vertical-align:-2px;
      box-shadow: 0 8px 16px rgba(255,204,51,.18);
    }
    .winHint{ position:relative; z-index:2; margin-top:12px; font-size:12px; opacity:.75; }

    /* ‚úÖ LOGIN GATE */
    .gateOverlay{
      position:fixed; inset:0; z-index:100000;
      display:none; align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .gateOverlay.show{ display:flex; }
    .gateCard{
      width:min(560px, 100%);
      border-radius:24px;
      border:1px solid rgba(37,215,255,.22);
      background: radial-gradient(900px 520px at 50% 10%, rgba(37,215,255,.14), rgba(10,12,24,.92));
      box-shadow: 0 22px 80px rgba(0,0,0,.65);
      padding:18px;
      color: rgba(234,243,255,.95);
    }
    .gateTitle{ font-size:26px; font-weight:950; margin-bottom:6px; }
    .gateSub{ opacity:.85; }
    .gateBtn{
      margin-top:14px;
      height:48px; width:100%;
      border-radius:18px;
      border:1px solid rgba(37,215,255,.45);
      background: linear-gradient(180deg, rgba(37,215,255,.95), rgba(0,183,255,.85));
      color:#061020; font-weight:950; cursor:pointer;
    }
    .gateBtn:active{ transform: translateY(1px); }
    .gateError{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,75,58,.35);
      background: rgba(255,75,58,.08);
      color: rgba(255,204,204,.95);
      font-weight:700;
    }
    .gateTip{ margin-top:10px; font-size:12px; opacity:.75; }
  `;
  document.head.appendChild(extra);

  // ---------------------------
  // Elements
  // ---------------------------
  const coinCountEl = document.getElementById("coinCount");

  // Settings
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsOverlay = document.getElementById("settingsOverlay");
  const settingsCloseBtn = document.getElementById("settingsCloseBtn");
  const soundToggle = document.getElementById("soundToggle");
  const vibrationToggle = document.getElementById("vibrationToggle");

  // Win popup
  const winOverlay = document.getElementById("winOverlay");
  const winSubText = document.getElementById("winSubText");
  const winNextBtn = document.getElementById("winNextBtn");
  const winAdBtn = document.getElementById("winAdBtn");

  // Login gate
  const gateOverlay = document.getElementById("loginGate");
  const gateLoginBtn = document.getElementById("gateLoginBtn");
  const gateError = document.getElementById("gateError");

  // Header login UI (still exposed for compatibility)
  const loginBtn = document.getElementById("loginBtn");
  const loginBtnText = document.getElementById("loginBtnText");
  const userPill = document.getElementById("userPill");

  // ---------------------------
  // State + handlers
  // ---------------------------
  let soundHandler = null;
  let vibrationHandler = null;

  let winNextHandler = null;
  let winAdHandler = null;

  // ‚úÖ first user gesture (for WebAudio unlock on mobile)
  let firstGestureHandler = null;
  window.addEventListener(
    "pointerdown",
    () => {
      firstGestureHandler?.();
      firstGestureHandler = null;
    },
    { once: true }
  );

  // ‚úÖ login gate click handler
  let loginClickHandler = null;
  gateLoginBtn.addEventListener("click", () => loginClickHandler?.());

  function setCoins(n) {
    coinCountEl.textContent = String(n ?? 0);
  }

  function openSettings() {
    settingsOverlay.classList.add("show");
    settingsOverlay.setAttribute("aria-hidden", "false");
  }

  function closeSettings() {
    settingsOverlay.classList.remove("show");
    settingsOverlay.setAttribute("aria-hidden", "true");
  }

  settingsBtn?.addEventListener("click", openSettings);
  settingsCloseBtn?.addEventListener("click", closeSettings);
  settingsOverlay?.addEventListener("click", (e) => {
    if (e.target === settingsOverlay) closeSettings();
  });

  soundToggle.addEventListener("change", () => {
    soundHandler?.(!!soundToggle.checked);
  });

  vibrationToggle.addEventListener("change", () => {
    vibrationHandler?.(!!vibrationToggle.checked);
  });

  // Win popup buttons
  winNextBtn.addEventListener("click", () => winNextHandler?.());
  winAdBtn.addEventListener("click", () => winAdHandler?.());

  function showWinPopup({ levelNumber, isLastLevel } = {}) {
    winSubText.textContent = isLastLevel
      ? `You finished the last level!`
      : `You finished Level ${levelNumber}`;

    winNextBtn.textContent = isLastLevel ? "Restart" : "Next level";

    winOverlay.classList.add("show");
    winOverlay.setAttribute("aria-hidden", "false");
  }

  function hideWinPopup() {
    winOverlay.classList.remove("show");
    winOverlay.setAttribute("aria-hidden", "true");
  }

  function setSoundEnabled(v) {
    soundToggle.checked = !!v;
  }

  function setVibrationEnabled(v) {
    vibrationToggle.checked = !!v;
  }

  /* ========== Login Gate API ========== */
  function showLoginGate() {
    gateError.style.display = "none";
    gateError.textContent = "";
    gateOverlay.classList.add("show");
    gateOverlay.setAttribute("aria-hidden", "false");
  }

  function hideLoginGate() {
    gateOverlay.classList.remove("show");
    gateOverlay.setAttribute("aria-hidden", "true");
  }

  function showLoginError(msg = "") {
    if (!msg) {
      gateError.style.display = "none";
      gateError.textContent = "";
    } else {
      gateError.style.display = "block";
      gateError.textContent = msg;
    }
  }

  function onLoginClick(fn) {
    loginClickHandler = fn;
  }

  function setUser(user) {
    const name = user?.username ?? "guest";
    userPill.textContent = `User: ${name}`;
    loginBtnText.textContent = "Logged in ‚úÖ";
  }
  /* ==================================== */

  return {
    canvas: document.getElementById("game"),
    loginBtn,
    loginBtnText,
    userPill,

    setCoins,

    // ‚úÖ audio unlock hook
    onFirstUserGesture(fn) {
      firstGestureHandler = fn;
    },

    // Settings API
    setSoundEnabled,
    setVibrationEnabled,
    onSoundToggle(fn) {
      soundHandler = fn;
    },
    onVibrationToggle(fn) {
      vibrationHandler = fn;
    },

    // Win popup API
    showWinPopup,
    hideWinPopup,
    onWinNext(fn) {
      winNextHandler = fn;
    },
    onWinAd(fn) {
      winAdHandler = fn;
    },

    // ‚úÖ Login gate API used by ensurePiLogin()
    showLoginGate,
    hideLoginGate,
    showLoginError,
    onLoginClick,
    setUser,
  };
}

/* ---------------- UI helpers ---------------- */
function iconBtn(id, svg, badgeText) {
  return `
    <button class="iconBtn" id="${id}">
      ${badgeText ? `<div class="badgeNew">${badgeText}</div>` : ""}
      ${svg}
    </button>
  `;
}

/* --- SVG functions --- */
function gearSVG() {
  return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="rgba(234,243,255,.95)" stroke-width="1.8"/>
    <path d="M19 13.2v-2.4l-2.1-.5a7.5 7.5 0 0 0-.6-1.4l1.2-1.8-1.7-1.7-1.8 1.2c-.5-.25-1-.45-1.5-.6L12.8 3h-2.4l-.5 2.1c-.5.15-1 .35-1.4.6L6.7 4.5 5 6.2l1.2 1.8c-.25.45-.45.95-.6 1.45L3.5 10.8v2.4l2.1.5c.15.5.35 1 .6 1.4L5 16.9l1.7 1.7 1.8-1.2c.45.25.95.45 1.45.6l.5 2.1h2.4l.5-2.1c.5-.15 1-.35 1.4-.6l1.8 1.2 1.7-1.7-1.2-1.8c.25-.45.45-.95.6-1.45L19 13.2Z" stroke="rgba(234,243,255,.75)" stroke-width="1.6" stroke-linejoin="round"/>
  </svg>`;
}

function joystickSVG() {
  return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M9 8.5c0-1.7 1.3-3 3-3s3 1.3 3 3v1.2c0 1.7-1.3 3-3 3s-3-1.3-3-3V8.5Z" stroke="rgba(234,243,255,.9)" stroke-width="1.8"/>
    <path d="M6.5 19.5h11c1.2 0 2.2-1 2.2-2.2 0-3-2.4-5.4-5.4-5.4H9.7c-3 0-5.4 2.4-5.4 5.4 0 1.2 1 2.2 2.2 2.2Z" stroke="rgba(234,243,255,.75)" stroke-width="1.8" stroke-linejoin="round"/>
    <path d="M7.3 15.3h2.4M16.3 15.3h-2.4" stroke="rgba(37,215,255,.95)" stroke-width="2.1" stroke-linecap="round"/>
  </svg>`;
}

function brushSVG() {
  return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M14.5 3.5 20.5 9.5 11 19c-.7.7-1.7 1-2.7.8l-2.8-.6.6-2.8c.2-1 .5-2 1.2-2.7L14.5 3.5Z" stroke="rgba(234,243,255,.85)" stroke-width="1.8" stroke-linejoin="round"/>
    <path d="M7.2 20.1c.1.8-.1 1.6-.7 2.2-.9.9-2.4.9-3.3 0" stroke="rgba(37,215,255,.95)" stroke-width="2.1" stroke-linecap="round"/>
  </svg>`;
}

function trophySVG() {
  return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M8 5h8v3.2c0 2.8-1.8 5.2-4 5.2s-4-2.4-4-5.2V5Z" stroke="rgba(234,243,255,.85)" stroke-width="1.8" stroke-linejoin="round"/>
    <path d="M9 19h6M10.2 16.5h3.6" stroke="rgba(234,243,255,.75)" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M6.5 6.2H4.5c0 3 1.4 4.8 3.6 5.4M17.5 6.2h2c0 3-1.4 4.8-3.6 5.4" stroke="rgba(37,215,255,.95)" stroke-width="1.8" stroke-linecap="round"/>
  </svg>`;
}

function noAdsSVG() {
  return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 7h10l-1 11H8L7 7Z" stroke="rgba(234,243,255,.85)" stroke-width="1.8" stroke-linejoin="round"/>
    <path d="M9 7V5.5c0-.8.7-1.5 1.5-1.5h3c.8 0 1.5.7 1.5 1.5V7" stroke="rgba(234,243,255,.75)" stroke-width="1.8" stroke-linejoin="round"/>
    <path d="M5 19 19 5" stroke="rgba(255,75,58,.95)" stroke-width="2.4" stroke-linecap="round"/>
  </svg>`;
}